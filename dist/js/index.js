var loadAndFetchSpine={init:function(){window.location.search?this.language=window.location.search.split("?")[1].split("=")[1]:this.language="en",this.spineItem,this.spineStorage={},localStorage.getItem("spineLoadedList")&&(this.spineStorage=JSON.parse(localStorage.getItem("spineLoadedList"))),this.loadedSpineArr=this.spineStorage,this.definedBack(),this.lanTitle(),this.fetchSpineInfo(),this.showAllSpine(),this.downLoadSpine()},definedBack:function(){$("header").click(function(){console.log("index definedBack"),window.MStore.definedBack()})},lanTitle:function(){switch(this.language){case"en":$("header span").html("Magic Store");break;case"zh":$("header span").html("魔法商店")}TweenMax.to($("header"),.5,{opacity:1,ease:Strong.easeOut})},loadedAnimate:function(){this.LoadTimeOut=setTimeout(function(){var e=$("#loading");TweenMax.to(e,1,{opacity:0,ease:Strong.easeOut,onComplete:function(){e.remove()}})},400)},fetchSpineInfo:function(){var e=this;$.ajax({type:"GET",async:!0,url:"https://mapi.magic-store.cn/mstore/spine/tree/details",data:{lan:this.language,limit:50},success:function(i){if(console.log(i),200==i.code){e.spineItem=i.entities;try{window.MStore.spineDomains(i.pkgBucket,i.imgBucket,i.endpoint)}catch(e){console.log(e.message)}e.createDetailSpines(e.spineItem,i.imgBucket,i.endpoint)}}})},spineLoadedList:function(e){var i=JSON.parse(e);if(console.log(i),i[0].isDelAllSpine){console.log("isDelAllSpine true"),this.spineStorage={};for(var s=1;s<i.length;s++)this.spineStorage[i[s].id]=i[s].objectKey;localStorage.setItem("spineLoadedList",JSON.stringify(this.spineStorage)),this.loadedSpineArr=this.spineStorage}else{console.log("isDelAllSpine false");for(var s=1;s<i.length;s++)this.spineStorage[i[s].id]=i[s].objectKey;this.spineStorage!=JSON.parse(localStorage.getItem("spineLoadedList"))&&(localStorage.setItem("spineLoadedList",JSON.stringify(this.spineStorage)),this.loadedSpineArr=this.spineStorage)}},createDetailSpines:function(e,i,s){for(var t=0;t<e.length;t++){var n=$('<div class="classify swiper-container"></div>');n.attr("data-categoryid",e[t].id);var a='<p class="spineTitle"><i>'+e[t].name+'</i><span class="showAll"></span></p> <div class="swiper-wrapper">',o=5;e[t].spines.length<=o&&(o=e[t].spines.length);for(var l=0;l<e[t].spines.length;l++){a+=l<4?'<div class="swiper-slide TMspine" data-source="'+e[t].spines[l].source+'" data-id="'+e[t].spines[l].id+'"><img class="magic TMmagic" src="http://'+i+"."+s+"/"+e[t].spines[l].cover+'" onerror="this.src=`../img/MS_icon.png`" />':'<div class="swiper-slide" data-source="'+e[t].spines[l].source+'" data-id="'+e[t].spines[l].id+'"><img class="magic" src="http://'+i+"."+s+"/"+e[t].spines[l].cover+'" onerror="this.src=`../img/MS_icon.png`" />';try{for(var r in this.loadedSpineArr){var c='<span class="download"></span></div>';if(e[t].spines[l].id==r){c="</div>";break}}if("{}"==JSON.stringify(this.loadedSpineArr))var c='<span class="download"></span></div>'}catch(e){console.log(e.message)}a+=c}a+='<i>M</i></div><p class="btm"></p>',n.html(a),$("section").append(n)}this.loadedAnimate();var d=$("section .classify");TweenMax.staggerTo(d,1,{opacity:1,ease:Linear.easeInOut},.3);var p=$("section .swiper-slide.TMspine");TweenMax.staggerFrom(p,1.5,{scale:.7,opacity:0,ease:Elastic.easeOut},.1)},showAllSpine:function(){var e=this;$("section").on("click",".classify .showAll",function(){window.location="list.html?lan="+e.language;var i=$(this).parents(".classify").index(),s={itemId:e.spineItem[i].id,itemName:e.spineItem[i].name};localStorage.setItem("itemInfo",JSON.stringify(s))})},downLoadSpine:function(){var e=this;$("section").on("click",".classify .swiper-slide",function(){if(1==$(this).find(".download").length){var i=$(this).find(".download");i.addClass("loading"),TweenMax.to(i,.9,{rotation:360,ease:Linear.easeOut,repeat:-1});var s=$(this).parents(".classify").index(),t=$(this).index(),n=e.spineItem[s].spines[t],a=$(this).find(".magic")[0].src;n.cover=a,console.log("indexDown spineInfo: "+JSON.stringify(n)),window.MStore.spineWillDownload($(this).data("source"),$(this).data("id"),JSON.stringify(n))}})},spineDidDownload:function(e,i){if(console.log("spineDidDownload"),e&&i){var s=$('section .swiper-container .swiper-slide[data-source="'+e+'"]'),t=s.find(".download");setTimeout(function(){TweenMax.to(t,.3,{scale:2,opacity:0,ease:Strong.easeOut,onComplete:function(){t.remove()}})},500),this.spineStorage[s.data("id")]=s.data("source"),localStorage.setItem("spineLoadedList",JSON.stringify(this.spineStorage))}}};loadAndFetchSpine.init();